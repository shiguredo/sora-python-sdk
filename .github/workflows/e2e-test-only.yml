name: e2e-test-only

on:
  push:
    branches:
      - develop
      - "feature/**"
    paths:
      - ".github/workflows/e2e-test-only.yml"
      - "tests/**"
  workflow_dispatch:

env:
  TEST_SIGNALING_URLS: ${{ secrets.TEST_SIGNALING_URLS }}
  TEST_CHANNEL_ID_PREFIX: ${{ secrets.TEST_CHANNEL_ID_PREFIX }}
  TEST_SECRET_KEY: ${{ secrets.TEST_SECRET_KEY }}
  TEST_API_URL: ${{ secrets.TEST_API_URL }}

jobs:
  e2e_test_ubuntu:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: ubuntu-24.04_x86_64
            runs_on: ubuntu-24.04
          - name: ubuntu-22.04_x86_64
            runs_on: ubuntu-22.04
        python_version:
          - "3.11"
          - "3.12"
          - "3.13"
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5
      
      # Tailscale のセットアップ
      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest

      # Linux 向けの依存関係インストール
      - run: |
          sudo apt-get update
          sudo apt-get -y install libx11-dev libdrm-dev libva-dev

      # UV のセットアップ
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      # Python バージョンの設定
      - run: uv python pin ${{ matrix.python_version }}

      # 依存関係のインストール
      - run: uv sync

      # Wheel ファイルのダウンロード
      - uses: ./.github/actions/download-whl
        id: download
        with:
          platform_name: ${{ matrix.platform.name }}
          python_version: ${{ matrix.python_version }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # wheel ファイルのインストール
      - name: Install wheel package
        run: |
          echo "Installing wheel: ${{ steps.download.outputs.wheel_file }}"
          uv add --dev "${{ steps.download.outputs.wheel_file }}"

      # E2E テストの実行
      - name: Run E2E tests
        run: |
          uv run pytest tests/ -v

      # エラー時の詳細情報
      - if: failure()
        name: Show debug information
        run: |
          echo "=== Python version ==="
          uv run python --version
          echo "=== Installed packages ==="
          uv pip list
          echo "=== Wheel files in dist/ ==="
          ls -la dist/ || echo "dist/ directory not found"

  e2e_test_macos:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macos_arm64
            runs_on: macos-15
        python_version:
          - "3.11"
          - "3.12"
          - "3.13"
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5
      
      # Tailscale のセットアップ
      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest

      # UV のセットアップ
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      # Python バージョンの設定
      - run: uv python pin ${{ matrix.python_version }}

      # 依存関係のインストール
      - run: uv sync

      # Wheel ファイルのダウンロード
      - uses: ./.github/actions/download-whl
        id: download
        with:
          platform_name: ${{ matrix.platform.name }}
          python_version: ${{ matrix.python_version }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # wheel ファイルのインストール
      - name: Install wheel package
        run: |
          echo "Installing wheel: ${{ steps.download.outputs.wheel_file }}"
          uv add --dev "${{ steps.download.outputs.wheel_file }}"

      # E2E テストの実行
      - name: Run E2E tests
        run: |
          uv run pytest tests/ -v

      # エラー時の詳細情報
      - if: failure()
        name: Show debug information
        run: |
          echo "=== Python version ==="
          uv run python --version
          echo "=== Installed packages ==="
          uv pip list
          echo "=== Wheel files in dist/ ==="
          ls -la dist/ || echo "dist/ directory not found"